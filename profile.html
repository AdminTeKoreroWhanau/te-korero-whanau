<!doctype html>
<html lang="mi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Kōtaha / Profile — Te Kōrero Whānau</title>
    <link rel="stylesheet" href="assets/styles.css" />
  </head>
  <body>
    <header class="papa">
      <div class="logo">Te Kōrero Whānau</div>
      <nav>
        <button class="nav-toggle" aria-expanded="false" aria-controls="whanau-nav" title="Whakatuwhera tahua / Open menu">≡</button>
        <button id="theme-toggle" class="theme-toggle" aria-pressed="false" title="Kōwhiri āhua / Toggle theme">☀︎</button>
        <ul id="whanau-nav" class="nav-list">
          <li><a href="index.html">Kāinga</a></li>
          <li><a href="whakapapa.html">Whakapapa</a></li>
          <li><a href="korero.html">Kōrero</a></li>
          <li><a href="waiata.html">Waiata</a></li>
          <li><a href="karakia.html">Karakia</a></li>
          <li><a href="nga-toi.html">Ngā Toi</a></li>
          <li id="nav-admin-item" style="display:none"><a href="admin.html">Admin</a></li>
          <li id="nav-login-item"><a id="open-auth" href="#">Login</a></li>
          <li id="nav-profile-item" style="display:none"><a href="profile.html">Kōtaha / Profile</a></li>
          <li id="nav-signout-item" style="display:none"><a id="signout" href="#">Takiputa / Sign out</a></li>
        </ul>
      </nav>
    </header>

    <main>
      <section class="profile-header">
        <div class="cover" aria-hidden="true">
          <img id="cover-img" alt="" />
        </div>
        <div class="profile-bar panel">
          <div class="avatar-wrap">
            <img id="avatar-img" class="avatar" alt="Avatar" />
          </div>
          <div class="profile-meta">
            <h1 id="profile-name">—</h1>
            <div class="muted small" id="profile-email"></div>
          </div>
          <div class="profile-actions">
            <button class="btn outline" id="edit-profile" type="button">Whakatika / Edit</button>
          </div>
        </div>
        <nav class="profile-tabs">
          <a href="#posts-section">Posts</a>
          <a href="#about-section">About</a>
          <a href="#photos-section">Photos</a>
        </nav>
      </section>

      <p class="muted" id="profile-status">Loading...</p>

      <section class="profile-layout">
        <div class="left-col">
          <section id="about-section" class="panel">
            <h2>Mō / About</h2>
            <div id="profile-info" style="display:none">
              <p><strong>Email:</strong> <span id="user-email"></span></p>
              <p><strong>Ingoa:</strong> <span id="user-name"></span></p>
            </div>
          </section>

          <section id="photos-section" class="panel">
            <h2>Whakaahua / Photos</h2>
            <div class="photos-grid" id="photos-grid"></div>
            <p class="muted small" id="photos-empty" style="display:none">Kāore anō he whakaahua / No photos yet.</p>
          </section>
        </div>
        <div class="right-col">
          <section class="panel composer">
            <h2>Tuhinga Hou / New post</h2>
            <form id="post-form" class="form">
              <textarea name="content" rows="3" placeholder="Tuhia ō kōrero..."></textarea>
              <div class="row">
                <label class="btn outline" for="composer-file">Tāpiri Whakaahua / Add photo</label>
                <input id="composer-file" type="file" name="file" accept="image/*,video/*" style="display:none" />
                <button class="btn" type="submit">Tukua / Post</button>
              </div>
              <p class="muted small" id="post-msg"></p>
            </form>
            <!-- Kept for compatibility with previous upload handler -->
            <form id="upload-form" class="form" style="display:none">
              <input type="file" name="file" accept="image/*,video/*" />
              <p class="muted small" id="upload-msg"></p>
            </form>
          </section>

          <section id="posts-section" class="panel">
            <h2>Ō Tuhinga / Your posts</h2>
            <div id="posts"></div>
          </section>
        </div>
      </section>
    </main>

    <!-- Auth modal reused here -->
    <div id="auth-modal" class="modal" hidden aria-hidden="true" role="dialog" aria-labelledby="auth-title">
      <div class="modal-content">
        <button class="modal-close" aria-label="Katia te matapihi / Close" id="auth-close">×</button>
        <h2 id="auth-title">Takiuru / Rēhita</h2>
        <div class="tabpanes">
          <form id="login-form" class="form" autocomplete="on">
            <label>Email
              <input type="email" name="email" required />
            </label>
            <label>Kupuhipa / Password
              <input type="password" name="password" required minlength="6" />
            </label>
            <button type="submit" class="btn">Takiuru</button>
            <p class="muted small" id="login-msg"></p>
          </form>
          <form id="register-form" class="form" autocomplete="on" hidden>
            <label>Ingoa / Full name (optional)
              <input type="text" name="full_name" />
            </label>
            <label>Email
              <input type="email" name="email" required />
            </label>
            <label>Kupuhipa / Password
              <input type="password" name="password" required minlength="6" />
            </label>
            <button type="submit" class="btn">Rēhita</button>
            <p class="muted small" id="register-msg"></p>
          </form>
        </div>
      </div>
    </div>

    <!-- Profile edit modal -->
    <div id="profile-modal" class="modal" hidden aria-hidden="true" role="dialog" aria-labelledby="profile-title">
      <div class="modal-content">
        <button class="modal-close" aria-label="Katia te matapihi / Close" id="profile-close">×</button>
        <h2 id="profile-title">Whakatika Kōtaha / Edit Profile</h2>
        <form id="profile-form" class="form">
          <label>Ingoa Katoa / Full name
            <input type="text" id="edit-full-name" name="full_name" placeholder="e.g., Rangi Tāmati" />
          </label>
          <label>Whakaahua Kōtaha / Avatar
            <input type="file" id="edit-avatar" name="avatar" accept="image/*" />
          </label>
          <label>Whakaahua Uhi / Cover photo
            <input type="file" id="edit-cover" name="cover" accept="image/*" />
          </label>
          <button type="submit" class="btn">Tiaki / Save</button>
          <p class="muted small" id="profile-msg"></p>
        </form>
      </div>
    </div>

    <footer>
      <small>© <span id="year"></span> Te Kōrero Whānau — He taonga tuku iho.</small>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="assets/config.js"></script>
    <script src="assets/ui-auth-fallback.js"></script>
    <script src="assets/auth.js"></script>
    <script>
      (function(){
        const statusEl = document.getElementById('profile-status');
        const infoEl = document.getElementById('profile-info');
        const emailEl = document.getElementById('user-email');
        const nameEl = document.getElementById('user-name');
        const postsRoot = document.getElementById('posts');
        const uploadForm = document.getElementById('upload-form');
        const uploadMsg = document.getElementById('upload-msg');
        const postForm = document.getElementById('post-form');
        const postMsg = document.getElementById('post-msg');
        const composerFile = document.getElementById('composer-file');
        const photosGrid = document.getElementById('photos-grid');
        const photosEmpty = document.getElementById('photos-empty');
        const profileName = document.getElementById('profile-name');
        const profileEmail = document.getElementById('profile-email');
        const avatarImg = document.getElementById('avatar-img');
        const coverImg = document.getElementById('cover-img');
        const editBtn = document.getElementById('edit-profile');
        const editModal = document.getElementById('profile-modal');
        const editClose = document.getElementById('profile-close');
        const editForm = document.getElementById('profile-form');
        const editFullName = document.getElementById('edit-full-name');
        const editAvatar = document.getElementById('edit-avatar');
        const editCover = document.getElementById('edit-cover');
        const profileMsg = document.getElementById('profile-msg');

        async function ensureSession(){
          const { data } = await sb.auth.getSession();
          const user = data.session?.user;
          if (!user){
            statusEl.textContent = 'Me takiuru tuatahitia / Please login first.';
            const openBtn = document.getElementById('open-auth');
            if (openBtn) openBtn.click();
            return null;
          }
          statusEl.style.display='none';
          infoEl.style.display='block';
          const fullName = user.user_metadata?.full_name || '';
          emailEl.textContent = user.email || '';
          nameEl.textContent = fullName || '—';
          if (profileName) profileName.textContent = fullName || (user.email || '').split('@')[0] || '—';
          if (profileEmail) profileEmail.textContent = user.email || '';
          // Optional profile images from metadata
          const avatarUrl = user.user_metadata?.avatar_url || '';
          if (avatarImg){ if (avatarUrl) { avatarImg.src = avatarUrl; } else { avatarImg.src = placeholderAvatar(user); } avatarImg.style.display='block'; }
          const coverUrl = user.user_metadata?.cover_url || '';
          if (coverImg){ if (coverUrl){ coverImg.src = coverUrl; } else { coverImg.src = placeholderCover(user); } coverImg.style.display='block'; }
          // Prefill edit form
          if (editFullName) editFullName.value = fullName || '';
          return user;
        }

        function renderPosts(list){
          if (!list || !list.length){ postsRoot.innerHTML = '<p class="muted">Kāore anō he tuhinga / No posts yet.</p>'; return; }
          postsRoot.innerHTML = '';
          list.forEach(p => {
            const wrap = document.createElement('article');
            wrap.className = 'panel';
            const t = new Date(p.created_at || Date.now()).toLocaleString();
            let mediaHtml = '';
            if (p.type === 'image' && p.media_url){ mediaHtml = `<img src="${p.media_url}" alt="" style="max-width:100%;border-radius:8px;border:1px solid var(--border)"/>`; }
            if (p.type === 'video' && p.media_url){ mediaHtml = `<video src="${p.media_url}" controls style="max-width:100%;border-radius:8px;border:1px solid var(--border)"></video>`; }
            wrap.innerHTML = `<div class="muted small">${t}</div>${p.content?`<p>${p.content}</p>`:''}${mediaHtml}`;
            postsRoot.appendChild(wrap);
          });
        }

        function renderPhotos(list){
          if (!photosGrid) return;
          const imgs = (list||[]).filter(p => p.type==='image' && p.media_url);
          photosGrid.innerHTML = '';
          if (!imgs.length){ if (photosEmpty) photosEmpty.style.display='block'; return; }
          if (photosEmpty) photosEmpty.style.display='none';
          const frag = document.createDocumentFragment();
          imgs.forEach(p => {
            const a = document.createElement('a'); a.href = p.media_url; a.target='_blank'; a.rel='noopener noreferrer';
            const img = document.createElement('img'); img.src = p.media_url; img.alt = ''; a.appendChild(img);
            frag.appendChild(a);
          });
          photosGrid.appendChild(frag);
        }

        async function loadPosts(user){
          try{
            const { data, error } = await sb.from('posts').select('*').eq('user_id', user.id).order('created_at', { ascending:false });
            if (error) throw error;
            renderPosts(data);
            renderPhotos(data);
          }catch(err){
            postsRoot.innerHTML = `<p class=\"muted small\">Unable to load posts. Ensure a 'posts' table exists in Supabase with columns: id uuid, user_id uuid, content text, type text, media_url text, created_at timestamptz default now().</p>`;
          }
        }

        function inferType(file){ return file.type.startsWith('video') ? 'video' : (file.type.startsWith('image') ? 'image' : 'file'); }

        // Placeholder generators (unique per user)
        function placeholderAvatar(user){
          const name = (user.user_metadata?.full_name || user.email || 'Whānau').trim();
          const initials = name.split(/\s+/).map(s=>s[0]).slice(0,2).join('').toUpperCase() || 'WH';
          const hue = Math.abs(hash(user.id || name)) % 360;
          const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='128' height='128'>
            <defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'><stop offset='0%' stop-color='hsl(${hue},70%,45%)'/><stop offset='100%' stop-color='hsl(${(hue+40)%360},70%,45%)'/></linearGradient></defs>
            <rect width='100%' height='100%' fill='url(#g)'/>
            <text x='50%' y='55%' dominant-baseline='middle' text-anchor='middle' fill='white' font-family='Segoe UI, Roboto, Arial' font-size='56' font-weight='700'>${initials}</text>
          </svg>`;
          return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
        }
        function placeholderCover(user){
          const hue = Math.abs(hash(user.id || 'cover')) % 360;
          const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='1200' height='360'>
            <defs><linearGradient id='cg' x1='0' y1='0' x2='1' y2='1'><stop offset='0%' stop-color='hsl(${(hue+20)%360},65%,35%)'/><stop offset='100%' stop-color='hsl(${(hue+80)%360},65%,35%)'/></linearGradient></defs>
            <rect width='100%' height='100%' fill='url(#cg)'/>
            <circle cx='90' cy='90' r='40' fill='rgba(255,255,255,.08)'/>
            <circle cx='220' cy='140' r='26' fill='rgba(255,255,255,.06)'/>
            <circle cx='400' cy='70' r='18' fill='rgba(255,255,255,.05)'/>
          </svg>`;
          return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
        }
        function hash(s){ let h=0; for (let i=0;i<s.length;i++){ h=((h<<5)-h)+s.charCodeAt(i); h|=0; } return h; }

        // Edit modal controls
        function showEdit(){ if (!editModal) return; editModal.hidden=false; editModal.setAttribute('aria-hidden','false'); }
        function hideEdit(){ if (!editModal) return; editModal.hidden=true; editModal.setAttribute('aria-hidden','true'); profileMsg.textContent=''; }
        editBtn && editBtn.addEventListener('click', showEdit);
        editClose && editClose.addEventListener('click', hideEdit);
        document.addEventListener('keydown', (e) => { if (e.key==='Escape' && editModal && !editModal.hidden) hideEdit(); });
        editModal && editModal.addEventListener('click', (e) => { if (e.target === editModal) hideEdit(); });

        async function uploadProfileFile(kind, file, user){
          const ext = (file.name.split('.').pop() || 'jpg').toLowerCase();
          const path = `profile/${user.id}/${kind}-${Date.now()}.${ext}`;
          const up = await sb.storage.from('media').upload(path, file, { upsert:true, cacheControl:'3600' });
          if (up.error) throw up.error;
          const { data: pub } = sb.storage.from('media').getPublicUrl(path);
          return pub.publicUrl;
        }

        if (uploadForm){
          uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            uploadMsg.textContent = '';
            const user = await ensureSession();
            if (!user) return;
            const fd = new FormData(uploadForm);
            const file = fd.get('file');
            if (!file || !file.name){ uploadMsg.textContent = 'Kōwhiria tētahi kōnae / Choose a file.'; return; }
            const ext = file.name.split('.').pop();
            const path = `${user.id}/${Date.now()}.${ext}`;
            try{
              const { error: upErr } = await sb.storage.from('media').upload(path, file, { upsert:false, cacheControl:'3600' });
              if (upErr) throw upErr;
              const { data: pub } = sb.storage.from('media').getPublicUrl(path);
              const type = inferType(file);
              const { error: insErr } = await sb.from('posts').insert({ user_id: user.id, type, media_url: pub.publicUrl });
              if (insErr) throw insErr;
              uploadMsg.textContent = 'Kua tukuna! / Uploaded';
              loadPosts(user);
            }catch(err){
              uploadMsg.textContent = 'Kāore i taea te tuku / Upload failed. Ensure a public storage bucket named "media" exists and RLS allows authenticated uploads.';
            }
          });
        }

        if (postForm){
          postForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            postMsg.textContent = '';
            const user = await ensureSession();
            if (!user) return;
            const fd = new FormData(postForm);
            const content = String(fd.get('content')||'').trim();
            const hasFile = composerFile && composerFile.files && composerFile.files[0];
            if (!content && !hasFile){ postMsg.textContent = 'Tāuruhia tētahi kōrero, kōwhiria rānei he kōnae / Enter some text or choose a file.'; return; }
            try{
              let insert = { user_id: user.id, content: content || null, type: content ? 'text' : null };
              if (hasFile){
                const file = composerFile.files[0];
                const ext = file.name.split('.').pop();
                const path = `${user.id}/${Date.now()}.${ext}`;
                const up = await sb.storage.from('media').upload(path, file, { upsert:false, cacheControl:'3600' });
                if (up.error) throw up.error;
                const { data: pub } = sb.storage.from('media').getPublicUrl(path);
                const type = inferType(file);
                insert.type = type; insert.media_url = pub.publicUrl;
              }
              if (!insert.type) insert.type = 'text';
              const { error } = await sb.from('posts').insert(insert);
              if (error) throw error;
              postMsg.textContent = 'Kua tukua! / Posted';
              postForm.reset(); if (composerFile) composerFile.value = '';
              loadPosts(user);
            }catch(err){
              postMsg.textContent = 'Kāore i taea te tuku / Failed to post. Ensure posts table exists and RLS allows authenticated inserts.';
            }
          });
        }

        // Save profile changes
        if (editForm){
          editForm.addEventListener('submit', async (e) => {
            e.preventDefault(); profileMsg.textContent='';
            const { data } = await sb.auth.getSession();
            const user = data.session?.user; if (!user){ profileMsg.textContent='Takiuru tuatahitia / Please login.'; return; }
            const updates = {};
            const full = (editFullName && editFullName.value || '').trim(); if (full) updates.full_name = full;
            try{
              if (editAvatar && editAvatar.files && editAvatar.files[0]){
                const url = await uploadProfileFile('avatar', editAvatar.files[0], user);
                updates.avatar_url = url;
              }
              if (editCover && editCover.files && editCover.files[0]){
                const url = await uploadProfileFile('cover', editCover.files[0], user);
                updates.cover_url = url;
              }
              if (Object.keys(updates).length){
                const { data: upd, error } = await sb.auth.updateUser({ data: updates });
                if (error) throw error;
                // Update UI
                const newUser = upd.user || user;
                if (profileName) profileName.textContent = (updates.full_name || newUser.user_metadata?.full_name || (newUser.email||'').split('@')[0] || '—');
                if (profileEmail) profileEmail.textContent = newUser.email || '';
                if (avatarImg) { const url = updates.avatar_url || newUser.user_metadata?.avatar_url || placeholderAvatar(newUser); avatarImg.src = url; avatarImg.style.display='block'; }
                if (coverImg) { const url = updates.cover_url || newUser.user_metadata?.cover_url || placeholderCover(newUser); coverImg.src = url; coverImg.style.display='block'; }
              }
              profileMsg.textContent = 'Kua tiakina / Saved';
              hideEdit();
            }catch(err){ profileMsg.textContent = 'Hapa / Error saving profile.'; }
          });
        }

        // Bootstrap
        (async function init(){
          const user = await ensureSession();
          if (user) loadPosts(user);
        })();
      })();
    </script>
    <script src="assets/app.js"></script>
  </body>
</html>
