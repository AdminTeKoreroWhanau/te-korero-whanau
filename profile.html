<!doctype html>
<html lang="mi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Kōtaha / Profile — Te Kōrero Whānau</title>
    <link rel="stylesheet" href="assets/styles.css" />
  </head>
  <body>
    <header class="papa">
      <div class="logo">Te Kōrero Whānau</div>
      <nav>
        <button class="nav-toggle" aria-expanded="false" aria-controls="whanau-nav" title="Whakatuwhera tahua / Open menu">≡</button>
        <button id="theme-toggle" class="theme-toggle" aria-pressed="false" title="Kōwhiri āhua / Toggle theme">☀︎</button>
        <ul id="whanau-nav" class="nav-list">
          <li><a href="index.html">Kāinga</a></li>
          <li><a href="whakapapa.html">Whakapapa</a></li>
          <li><a href="korero.html">Kōrero</a></li>
          <li><a href="mahi.html">Mahi</a></li>
          <li><a href="tauparapara.html">Tauparapara</a></li>
          <li><a href="nga-toi.html">Ngā Toi</a></li>
          <li id="nav-admin-item" style="display:none"><a href="admin.html">Kaiwhakahaere</a></li>
          <li id="nav-login-item"><a id="open-auth" href="#">Takiuru</a></li>
          <li id="nav-profile-item" style="display:none"><a href="profile.html">Kōtaha</a></li>
          <li id="nav-signout-item" style="display:none"><a id="signout" href="#">Takiputa</a></li>
        </ul>
      </nav>
    </header>

    <main>
      <section class="profile-header">
        <div class="cover" aria-hidden="true">
          <img id="cover-img" alt="" />
        </div>
        <div class="profile-bar panel">
          <div class="avatar-wrap">
            <img id="avatar-img" class="avatar" alt="Avatar" />
          </div>
          <div class="profile-meta">
            <h1 id="profile-name">—</h1>
          </div>
          <div class="profile-actions">
            <button class="btn outline lang-swap" id="edit-profile" type="button"><span class="lang mi">Whakatika</span><span class="lang en">Edit</span></button>
          </div>
        </div>
      </section>

      <p class="muted" id="profile-status">Loading...</p>

      <section class="profile-layout">
        <div class="left-col">
          <section id="pepeha-section" class="panel">
            <h2>Pepeha</h2>
            <div id="pepeha-view" style="display:none"></div>
            <p id="pepeha-empty" class="muted small">Kāore anō he pepeha / No pepeha yet.</p>
          </section>

          <section id="photos-section" class="panel">
            <h2>Whakaahua / Photos</h2>
            <div class="photos-grid" id="photos-grid"></div>
            <p class="muted small" id="photos-empty" style="display:none">Kāore anō he whakaahua / No photos yet.</p>
          </section>
        </div>
        <div class="right-col">
          <section class="panel composer">
            <h2>Tuhinga Hou / New post</h2>
            <form id="post-form" class="form">
              <textarea name="content" rows="3" placeholder="Tuhia ō kōrero..."></textarea>
              <div class="row">
                <label class="btn outline lang-swap" for="composer-file"><span class="lang mi">Tāpiri Whakaahua</span><span class="lang en">Add photo</span></label>
                <input id="composer-file" type="file" name="file" accept="image/*,video/*" style="display:none" />
                <button class="btn lang-swap" type="submit"><span class="lang mi">Tukua</span><span class="lang en">Post</span></button>
              </div>
              <p class="muted small" id="post-msg"></p>
            </form>
            <!-- Kept for compatibility with previous upload handler -->
            <form id="upload-form" class="form" style="display:none">
              <input type="file" name="file" accept="image/*,video/*" />
              <p class="muted small" id="upload-msg"></p>
            </form>
          </section>

          <section id="posts-section" class="panel">
            <h2>Ō Tuhinga / Your posts</h2>
            <div id="posts"></div>
          </section>
        </div>
      </section>
    </main>

    <!-- Auth modal reused here -->
    <div id="auth-modal" class="modal" hidden aria-hidden="true" role="dialog" aria-labelledby="auth-title">
      <div class="modal-content">
        <button class="modal-close" aria-label="Katia te matapihi / Close" id="auth-close">×</button>
        <h2 id="auth-title">Takiuru / Rēhita</h2>
        <div class="tabpanes">
          <form id="login-form" class="form" autocomplete="on">
            <label>Email
              <input type="email" name="email" required />
            </label>
            <label>Kupuhipa / Password
              <input type="password" name="password" required minlength="6" />
            </label>
            <button type="submit" class="btn lang-swap"><span class="lang mi">Takiuru</span><span class="lang en">Login</span></button>
            <p class="muted small" id="login-msg"></p>
          </form>
          <form id="register-form" class="form" autocomplete="on" hidden>
            <label>Ingoa / Full name (optional)
              <input type="text" name="full_name" />
            </label>
            <label>Email
              <input type="email" name="email" required />
            </label>
            <label>Kupuhipa / Password
              <input type="password" name="password" required minlength="6" />
            </label>
            <button type="submit" class="btn lang-swap"><span class="lang mi">Rēhita</span><span class="lang en">Register</span></button>
            <p class="muted small" id="register-msg"></p>
          </form>
        </div>
      </div>
    </div>

    <!-- Profile edit modal -->
    <div id="profile-modal" class="modal" hidden aria-hidden="true" role="dialog" aria-labelledby="profile-title">
      <div class="modal-content">
        <button class="modal-close" aria-label="Katia te matapihi / Close" id="profile-close">×</button>
        <h2 id="profile-title">Whakatika Kōtaha / Edit Profile</h2>
        <form id="profile-form" class="form">
          <label>Ingoa Katoa / Full name
            <input type="text" id="edit-full-name" name="full_name" placeholder="e.g., Rangi Tāmati" />
          </label>
          <label>Whakaahua Kōtaha / Avatar
            <input type="file" id="edit-avatar" name="avatar" accept="image/*" />
            <div id="avatar-preview" style="display:none;margin-top:.5rem">
              <img id="avatar-preview-img" alt="Avatar preview" style="width:112px;height:112px;border-radius:10px;border:2px solid var(--border);object-fit:cover" />
            </div>
          </label>
          <label>Whakaahua Uhi / Cover photo
            <input type="file" id="edit-cover" name="cover" accept="image/*" />
            <div id="cover-preview" style="display:none;margin-top:.5rem">
              <img id="cover-preview-img" alt="Cover preview" style="width:100%;max-width:400px;height:120px;border-radius:8px;border:2px solid var(--border);object-fit:cover" />
            </div>
          </label>
          <fieldset>
            <legend>Pepeha</legend>
            <label>Maunga
              <input type="text" id="edit-maunga" name="pepeha_maunga" />
            </label>
            <label>Awa
              <input type="text" id="edit-awa" name="pepeha_awa" />
            </label>
            <label>Iwi
              <input type="text" id="edit-iwi" name="pepeha_iwi" />
            </label>
            <label>Hapū
              <input type="text" id="edit-hapu" name="pepeha_hapu" />
            </label>
            <label>Waka
              <input type="text" id="edit-waka" name="pepeha_waka" />
            </label>
            <label>Marae
              <input type="text" id="edit-marae" name="pepeha_marae" />
            </label>
          </fieldset>
          <button type="submit" class="btn lang-swap"><span class="lang mi">Tiaki</span><span class="lang en">Save</span></button>
          <p class="muted small" id="profile-msg"></p>
        </form>
      </div>
      </div>

      <!-- Photo lightbox modal -->
      <div id="photo-modal" class="modal" hidden aria-hidden="true" role="dialog" aria-labelledby="photo-title">
        <div class="modal-content">
          <button class="modal-close" aria-label="Katia te matapihi / Close" id="photo-close">×</button>
          <h2 id="photo-title" class="visually-hidden">Whakaahua</h2>
          <figure style="margin:0">
            <img id="photo-modal-img" alt="" style="width:100%;max-height:70vh;object-fit:contain;border-radius:8px;border:1px solid var(--border)" />
            <figcaption id="photo-modal-caption" class="muted small" style="margin-top:.5rem"></figcaption>
          </figure>
          <div class="owner-actions" style="margin-top:.75rem;display:flex;gap:.5rem">
            <button class="btn outline lang-swap" id="photo-modal-edit" type="button"><span class="lang mi">Whakatika</span><span class="lang en">Edit</span></button>
            <button class="btn outline lang-swap" id="photo-modal-delete" type="button"><span class="lang mi">Muku</span><span class="lang en">Delete</span></button>
          </div>
      </div>
      </div>

      <!-- Post view modal -->
      <div id="post-modal" class="modal" hidden aria-hidden="true" role="dialog" aria-labelledby="post-title">
        <div class="modal-content">
          <button class="modal-close" aria-label="Katia te matapihi / Close" id="post-close">×</button>
          <h2 id="post-title" class="visually-hidden">Tirohia te tuhinga / View post</h2>
          <div class="muted small" id="post-modal-time" style="margin-bottom:.5rem"></div>
          <div id="post-modal-content" style="white-space:pre-wrap"></div>
          <div id="post-modal-media" style="margin-top:.5rem"></div>
        </div>
      </div>

      <footer>
        <small>© <span id="year"></span> Te Kōrero Whānau — He taonga tuku iho.</small>
      </footer>

      <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
      <script src="assets/config.js"></script>
      <script src="assets/ui-auth-fallback.js"></script>
      <script src="assets/auth.js"></script>
      <script>
        (function(){
          const statusEl = document.getElementById('profile-status');
          const pepehaView = document.getElementById('pepeha-view');
          const pepehaEmpty = document.getElementById('pepeha-empty');
          const postsRoot = document.getElementById('posts');
          const uploadForm = document.getElementById('upload-form');
          const uploadMsg = document.getElementById('upload-msg');
          const postForm = document.getElementById('post-form');
          const postMsg = document.getElementById('post-msg');
          const composerFile = document.getElementById('composer-file');
          const photosGrid = document.getElementById('photos-grid');
          const photosEmpty = document.getElementById('photos-empty');
          const profileName = document.getElementById('profile-name');
          const avatarImg = document.getElementById('avatar-img');
          const coverImg = document.getElementById('cover-img');
          const coverWrap = document.querySelector('.profile-header .cover');
          const editBtn = document.getElementById('edit-profile');
          const editModal = document.getElementById('profile-modal');
          const editClose = document.getElementById('profile-close');
          const editForm = document.getElementById('profile-form');
          const editFullName = document.getElementById('edit-full-name');
          const editAvatar = document.getElementById('edit-avatar');
          const editCover = document.getElementById('edit-cover');
          const editMaunga = document.getElementById('edit-maunga');
          const editAwa = document.getElementById('edit-awa');
          const editIwi = document.getElementById('edit-iwi');
          const editHapu = document.getElementById('edit-hapu');
          const editWaka = document.getElementById('edit-waka');
          const editMarae = document.getElementById('edit-marae');
          const profileMsg = document.getElementById('profile-msg');
          // Photo modal elements
          const photoModal = document.getElementById('photo-modal');
          const photoClose = document.getElementById('photo-close');
          const photoImg = document.getElementById('photo-modal-img');
          const photoCaption = document.getElementById('photo-modal-caption');
          const photoEditBtn = document.getElementById('photo-modal-edit');
          const photoDeleteBtn = document.getElementById('photo-modal-delete');
          // Post modal elements
          const postModal = document.getElementById('post-modal');
          const postClose = document.getElementById('post-close');
          const postTime = document.getElementById('post-modal-time');
          const postBody = document.getElementById('post-modal-content');
          const postMedia = document.getElementById('post-modal-media');
          let currentPosts = [];
          let currentPhotoId = null;
          let currentPostId = null;

        async function ensureSession(){
          const { data: sess } = await sb.auth.getSession();
          let user = sess.session?.user;
          // Fetch fresh user to ensure latest metadata (e.g., cover_url)
          try {
            const { data: u } = await sb.auth.getUser();
            if (u && u.user) user = u.user;
          } catch {}
          if (!user){
            statusEl.textContent = 'Me takiuru tuatahitia / Please login first.';
            const openBtn = document.getElementById('open-auth');
            if (openBtn) openBtn.click();
            return null;
          }
          statusEl.style.display='none';
          const fullName = user.user_metadata?.full_name || '';
          if (profileName) profileName.textContent = fullName || '—';
          // Render pepeha if present
          const pepeha = user.user_metadata?.pepeha || null;
          renderPepeha(pepeha);
          // Optional profile images from metadata
          const avatarUrl = user.user_metadata?.avatar_url || '';
          if (avatarImg){ if (avatarUrl) { avatarImg.src = avatarUrl; } else { avatarImg.src = placeholderAvatar(user); } avatarImg.style.display='block'; }
          const coverUrl = user.user_metadata?.cover_url || '';
          applyCover(coverUrl || placeholderCover(user), user);
          // Prefill edit form
          if (editFullName) editFullName.value = fullName || '';
          if (pepeha){
            if (editMaunga) editMaunga.value = pepeha.maunga || '';
            if (editAwa) editAwa.value = pepeha.awa || '';
            if (editIwi) editIwi.value = pepeha.iwi || '';
            if (editHapu) editHapu.value = pepeha.hapu || '';
            if (editWaka) editWaka.value = pepeha.waka || '';
            if (editMarae) editMarae.value = pepeha.marae || '';
          }
          return user;
        }

        function renderPosts(list){
          if (!list || !list.length){ postsRoot.innerHTML = '<p class="muted">Kāore anō he tuhinga / No posts yet.</p>'; return; }
          postsRoot.innerHTML = '';
          list.forEach(p => {
            const wrap = document.createElement('article');
            wrap.className = 'panel';
            wrap.setAttribute('data-id', p.id);
            const t = new Date(p.created_at || Date.now()).toLocaleString();
            let mediaHtml = '';
            if (p.type === 'image' && p.media_url){ mediaHtml = `<img src=\"${p.media_url}\" alt=\"\" style=\"max-width:100%;border-radius:8px;border:1px solid var(--border)\"/>`; }
            if (p.type === 'video' && p.media_url){ mediaHtml = `<video src=\"${p.media_url}\" controls style=\"max-width:100%;border-radius:8px;border:1px solid var(--border)\"></video>`; }
            // Truncate long text and add Read more link
            let contentHtml = '';
            if (p.content){
              const text = String(p.content);
              const limit = 220;
              if (text.length > limit){
                const cut = text.slice(0, limit);
                const end = Math.max(cut.lastIndexOf(' '), limit - 20);
                const short = cut.slice(0, end > 0 ? end : limit) + '…';
                contentHtml = `<p>${short} <button class=\"btn-link read-more\" data-id=\"${p.id}\" type=\"button\" aria-label=\"Read full post\">Read more</button></p>`;
              } else {
                contentHtml = `<p>${text}</p>`;
              }
            }
            const actions = `<div class=\"owner-actions\" style=\"margin-top:.5rem;display:flex;gap:.5rem;justify-content:flex-end\">\n              <button class=\"btn outline lang-swap post-edit\" data-id=\"${p.id}\" type=\"button\"><span class=\"lang mi\">Whakatika</span><span class=\"lang en\">Edit</span></button>\n              <button class=\"btn outline lang-swap post-delete\" data-id=\"${p.id}\" type=\"button\"><span class=\"lang mi\">Muku</span><span class=\"lang en\">Delete</span></button>\n            </div>`;
            wrap.innerHTML = `<div class=\\\"muted small\\\">${t}</div>${contentHtml}${mediaHtml}${actions}`;
            postsRoot.appendChild(wrap);
          });
        }

        function applyCover(url){
          try{
            const withV = url ? url + (url.includes('?') ? '&' : '?') + 'v=' + Date.now() : '';
            if (coverImg){
              coverImg.onerror = () => { coverImg.src = ''; };
              coverImg.src = withV || url;
              coverImg.style.display='block';
            }
            if (coverWrap){
              const bgUrl = withV || url || '';
              if (bgUrl){
                coverWrap.style.backgroundImage = `linear-gradient(135deg, rgba(0,196,179,.25), transparent 60%), url('${bgUrl}')`;
                coverWrap.style.backgroundSize = 'auto, cover';
                coverWrap.style.backgroundPosition = 'center, center';
              }
            }
          }catch(_){/* noop */}
        }

        function renderPepeha(p){
          if (!pepehaView || !pepehaEmpty) return;
          const has = p && Object.keys(p).some(k => (p[k]||'').trim() !== '');
          if (!has){
            pepehaView.style.display='none';
            pepehaView.innerHTML='';
            pepehaEmpty.style.display='block';
            return;
          }
          pepehaEmpty.style.display='none';
          const rows = [];
          if (p.maunga) rows.push(`<p><strong>Maunga:</strong> ${p.maunga}</p>`);
          if (p.awa) rows.push(`<p><strong>Awa:</strong> ${p.awa}</p>`);
          if (p.iwi) rows.push(`<p><strong>Iwi:</strong> ${p.iwi}</p>`);
          if (p.hapu) rows.push(`<p><strong>Hapū:</strong> ${p.hapu}</p>`);
          if (p.waka) rows.push(`<p><strong>Waka:</strong> ${p.waka}</p>`);
          if (p.marae) rows.push(`<p><strong>Marae:</strong> ${p.marae}</p>`);
          pepehaView.innerHTML = rows.join('');
          pepehaView.style.display='block';
        }

        function renderPhotos(list){
          if (!photosGrid) return;
          const imgs = (list||[]).filter(p => p.type==='image' && p.media_url);
          photosGrid.innerHTML = '';
          if (!imgs.length){ if (photosEmpty) photosEmpty.style.display='block'; return; }
          if (photosEmpty) photosEmpty.style.display='none';
          const frag = document.createDocumentFragment();
          imgs.forEach(p => {
            const item = document.createElement('div'); item.className = 'photo-item'; item.setAttribute('data-id', p.id);
            const a = document.createElement('a'); a.href = p.media_url; a.target='_blank'; a.rel='noopener noreferrer';
            const img = document.createElement('img'); img.src = p.media_url; img.alt = ''; a.appendChild(img);
            item.appendChild(a);
            frag.appendChild(item);
          });
          photosGrid.appendChild(frag);
        }

        async function loadPosts(user){
          try{
            const { data, error } = await sb.from('posts').select('*').eq('user_id', user.id).order('created_at', { ascending:false });
            if (error) throw error;
            currentPosts = data || [];
            renderPosts(currentPosts);
            renderPhotos(currentPosts);
          }catch(err){
            postsRoot.innerHTML = `<p class=\"muted small\">Unable to load posts. Ensure a 'posts' table exists in Supabase with columns: id uuid, user_id uuid, content text, type text, media_url text, created_at timestamptz default now().</p>`;
          }
        }

        function inferType(file){ return file.type.startsWith('video') ? 'video' : (file.type.startsWith('image') ? 'image' : 'file'); }

        // Placeholder generators (unique per user)
        function placeholderAvatar(user){
          const name = (user.user_metadata?.full_name || user.email || 'Whānau').trim();
          const initials = name.split(/\s+/).map(s=>s[0]).slice(0,2).join('').toUpperCase() || 'WH';
          const hue = Math.abs(hash(user.id || name)) % 360;
          const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='128' height='128'>
            <defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'><stop offset='0%' stop-color='hsl(${hue},70%,45%)'/><stop offset='100%' stop-color='hsl(${(hue+40)%360},70%,45%)'/></linearGradient></defs>
            <rect width='100%' height='100%' fill='url(#g)'/>
            <text x='50%' y='55%' dominant-baseline='middle' text-anchor='middle' fill='white' font-family='Segoe UI, Roboto, Arial' font-size='56' font-weight='700'>${initials}</text>
          </svg>`;
          return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
        }
        function placeholderCover(user){
          const hue = Math.abs(hash(user.id || 'cover')) % 360;
          const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='1200' height='360'>
            <defs><linearGradient id='cg' x1='0' y1='0' x2='1' y2='1'><stop offset='0%' stop-color='hsl(${(hue+20)%360},65%,35%)'/><stop offset='100%' stop-color='hsl(${(hue+80)%360},65%,35%)'/></linearGradient></defs>
            <rect width='100%' height='100%' fill='url(#cg)'/>
            <circle cx='90' cy='90' r='40' fill='rgba(255,255,255,.08)'/>
            <circle cx='220' cy='140' r='26' fill='rgba(255,255,255,.06)'/>
            <circle cx='400' cy='70' r='18' fill='rgba(255,255,255,.05)'/>
          </svg>`;
          return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
        }
        function hash(s){ let h=0; for (let i=0;i<s.length;i++){ h=((h<<5)-h)+s.charCodeAt(i); h|=0; } return h; }
        function storagePathFromPublicUrl(url){
          try{
            const marker = '/object/public/';
            const i = url.indexOf(marker);
            if (i === -1) return null;
            const rest = url.substring(i + marker.length); // e.g., 'media/userid/filename.jpg'
            const slash = rest.indexOf('/');
            if (slash === -1) return null;
            return rest.substring(slash + 1); // path within bucket
          }catch(_){ return null; }
        }

        // Image preview elements
        const avatarPreview = document.getElementById('avatar-preview');
        const avatarPreviewImg = document.getElementById('avatar-preview-img');
        const coverPreview = document.getElementById('cover-preview');
        const coverPreviewImg = document.getElementById('cover-preview-img');

        // Preview avatar on file selection
        if (editAvatar && avatarPreview && avatarPreviewImg) {
          editAvatar.addEventListener('change', (e) => {
            const file = e.target.files && e.target.files[0];
            if (file && file.type.startsWith('image/')) {
              const reader = new FileReader();
              reader.onload = (ev) => {
                avatarPreviewImg.src = ev.target.result;
                avatarPreview.style.display = 'block';
              };
              reader.readAsDataURL(file);
            } else {
              avatarPreview.style.display = 'none';
              avatarPreviewImg.src = '';
            }
          });
        }

        // Preview cover on file selection
        if (editCover && coverPreview && coverPreviewImg) {
          editCover.addEventListener('change', (e) => {
            const file = e.target.files && e.target.files[0];
            if (file && file.type.startsWith('image/')) {
              const reader = new FileReader();
              reader.onload = (ev) => {
                coverPreviewImg.src = ev.target.result;
                coverPreview.style.display = 'block';
              };
              reader.readAsDataURL(file);
            } else {
              coverPreview.style.display = 'none';
              coverPreviewImg.src = '';
            }
          });
        }

        // Edit modal controls
        function showEdit(){ if (!editModal) return; editModal.hidden=false; editModal.setAttribute('aria-hidden','false'); }
        function hideEdit(){ 
          if (!editModal) return; 
          editModal.hidden=true; 
          editModal.setAttribute('aria-hidden','true'); 
          profileMsg.textContent=''; 
          // Clear previews when modal closes
          if (avatarPreview) avatarPreview.style.display = 'none';
          if (avatarPreviewImg) avatarPreviewImg.src = '';
          if (coverPreview) coverPreview.style.display = 'none';
          if (coverPreviewImg) coverPreviewImg.src = '';
        }
        editBtn && editBtn.addEventListener('click', showEdit);
        editClose && editClose.addEventListener('click', hideEdit);
        document.addEventListener('keydown', (e) => { if (e.key==='Escape' && editModal && !editModal.hidden) hideEdit(); });
        editModal && editModal.addEventListener('click', (e) => { if (e.target === editModal) hideEdit(); });

        async function uploadProfileFile(kind, file, user){
          const ext = (file.name.split('.').pop() || 'jpg').toLowerCase();
          const path = `profile/${user.id}/${kind}-${Date.now()}.${ext}`;
          const up = await sb.storage.from('media').upload(path, file, { upsert:true, cacheControl:'3600', contentType: file.type || undefined });
          if (up.error) throw up.error;
          const { data: pub } = sb.storage.from('media').getPublicUrl(path);
          return pub.publicUrl;
        }

        if (uploadForm){
          uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            uploadMsg.textContent = '';
            const user = await ensureSession();
            if (!user) return;
            const fd = new FormData(uploadForm);
            const file = fd.get('file');
            if (!file || !file.name){ uploadMsg.textContent = 'Kōwhiria tētahi kōnae / Choose a file.'; return; }
            const ext = file.name.split('.').pop();
            const path = `${user.id}/${Date.now()}.${ext}`;
            try{
              const { error: upErr } = await sb.storage.from('media').upload(path, file, { upsert:false, cacheControl:'3600' });
              if (upErr) throw upErr;
              const { data: pub } = sb.storage.from('media').getPublicUrl(path);
              const type = inferType(file);
              const { error: insErr } = await sb.from('posts').insert({ user_id: user.id, type, media_url: pub.publicUrl });
              if (insErr) throw insErr;
              uploadMsg.textContent = 'Kua tukuna! / Uploaded';
              loadPosts(user);
            }catch(err){
              uploadMsg.textContent = 'Kāore i taea te tuku / Upload failed. Ensure a public storage bucket named "media" exists and RLS allows authenticated uploads.';
            }
          });
        }

        if (postForm){
          postForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            postMsg.textContent = '';
            const user = await ensureSession();
            if (!user) return;
            const fd = new FormData(postForm);
            const content = String(fd.get('content')||'').trim();
            const hasFile = composerFile && composerFile.files && composerFile.files[0];
            if (!content && !hasFile){ postMsg.textContent = 'Tāuruhia tētahi kōrero, kōwhiria rānei he kōnae / Enter some text or choose a file.'; return; }
            try{
              let insert = { user_id: user.id, content: content || null, type: content ? 'text' : null };
              if (hasFile){
                const file = composerFile.files[0];
                const ext = file.name.split('.').pop();
                const path = `${user.id}/${Date.now()}.${ext}`;
                const up = await sb.storage.from('media').upload(path, file, { upsert:false, cacheControl:'3600' });
                if (up.error) throw up.error;
                const { data: pub } = sb.storage.from('media').getPublicUrl(path);
                const type = inferType(file);
                insert.type = type; insert.media_url = pub.publicUrl;
              }
              if (!insert.type) insert.type = 'text';
              const { error } = await sb.from('posts').insert(insert);
              if (error) throw error;
              postMsg.textContent = 'Kua tukua! / Posted';
              postForm.reset(); if (composerFile) composerFile.value = '';
              loadPosts(user);
            }catch(err){
              postMsg.textContent = 'Kāore i taea te tuku / Failed to post. Ensure posts table exists and RLS allows authenticated inserts.';
            }
          });
        }

        // View/Edit/Delete handlers for posts list (open modal on article click)
        if (postsRoot){
          postsRoot.addEventListener('click', async (e) => {
            const moreBtn = e.target.closest && e.target.closest('button.read-more');
            if (moreBtn){
              const id = moreBtn.getAttribute('data-id');
              const post = currentPosts.find(p => String(p.id) === String(id));
              if (post) showPost(post);
              return;
            }
            const editBtn = e.target.closest && e.target.closest('button.post-edit');
            const delBtn = e.target.closest && e.target.closest('button.post-delete');
            // Edit/Delete buttons behavior
            if (editBtn || delBtn){
              const user = await ensureSession(); if (!user) return;
              const id = (editBtn||delBtn).getAttribute('data-id');
              const post = currentPosts.find(p => String(p.id) === String(id));
              if (!post) return;
              if (editBtn){
                const next = window.prompt('Whakatika tuhinga / Edit post content:', post.content || '');
                if (next == null) return;
                try{
                  const { error } = await sb.from('posts').update({ content: next }).eq('id', id).eq('user_id', user.id);
                  if (error) throw error;
                  await loadPosts(user);
                  // if modal open for this post, update content
                  if (currentPostId && String(currentPostId) === String(id) && postBody){ postBody.textContent = next; }
                }catch(_){ alert('Kāore i taea te whakatika / Failed to edit.'); }
              }
              if (delBtn){
                if (!window.confirm('Muku tēnei? / Delete this?')) return;
                try{
                  // delete media if any
                  if (post.media_url && post.type && post.type !== 'text'){
                    const path = storagePathFromPublicUrl(post.media_url);
                    if (path){ await sb.storage.from('media').remove([path]); }
                  }
                  const { error } = await sb.from('posts').delete().eq('id', id).eq('user_id', user.id);
                  if (error) throw error;
                  await loadPosts(user);
                  if (currentPostId && String(currentPostId) === String(id)) hidePost();
                }catch(_){ alert('Kāore i taea te muku / Failed to delete.'); }
              }
              return;
            }
            // Open modal when clicking anywhere on a post (except buttons)
            const art = e.target.closest && e.target.closest('article.panel');
            if (!art) return;
            const id = art.getAttribute('data-id');
            const post = currentPosts.find(p => String(p.id) === String(id));
            if (!post) return;
            // Only open on card click if the post has an image; otherwise require Read more
            if (!(post.type === 'image' && post.media_url)) return;
            showPost(post);
          });
        }

        // Photo modal helpers
        function showPhoto(post){
          if (!photoModal || !photoImg) return;
          currentPhotoId = post.id;
          const withV = post.media_url ? post.media_url + (post.media_url.includes('?') ? '&' : '?') + 'v=' + Date.now() : '';
          photoImg.src = withV || post.media_url;
          photoCaption.textContent = post.content || '';
          photoModal.hidden = false;
          photoModal.setAttribute('aria-hidden','false');
        }
        function hidePhoto(){
          if (!photoModal) return;
          photoModal.hidden = true;
          photoModal.setAttribute('aria-hidden','true');
          if (photoImg) photoImg.src = '';
          currentPhotoId = null;
        }
        photoClose && photoClose.addEventListener('click', hidePhoto);
        photoModal && photoModal.addEventListener('click', (e) => { if (e.target === photoModal) hidePhoto(); });
        document.addEventListener('keydown', (e) => { if (e.key==='Escape' && photoModal && !photoModal.hidden) hidePhoto(); });

        // Post modal helpers
        function showPost(post){
          if (!postModal) return;
          currentPostId = post.id;
          if (postTime) postTime.textContent = new Date(post.created_at || Date.now()).toLocaleString();
          if (postBody) postBody.textContent = post.content || '';
          if (postMedia){
            postMedia.innerHTML = '';
            if (post.type === 'image' && post.media_url){
              const img = document.createElement('img');
              img.src = post.media_url;
              img.alt='';
              img.style.maxWidth = '100%';
              img.style.maxHeight = '70vh';
              img.style.borderRadius = '8px';
              img.style.border = '1px solid var(--border)';
              postMedia.appendChild(img);
            } else if (post.type === 'video' && post.media_url){
              const vid = document.createElement('video');
              vid.src = post.media_url; vid.controls = true;
              vid.style.maxWidth = '100%';
              vid.style.borderRadius = '8px';
              vid.style.border = '1px solid var(--border)';
              postMedia.appendChild(vid);
            }
          }
          postModal.hidden = false;
          postModal.setAttribute('aria-hidden','false');
        }
        function hidePost(){
          if (!postModal) return;
          postModal.hidden = true;
          postModal.setAttribute('aria-hidden','true');
          if (postMedia) postMedia.innerHTML = '';
          currentPostId = null;
        }
        postClose && postClose.addEventListener('click', hidePost);
        postModal && postModal.addEventListener('click', (e) => { if (e.target === postModal) hidePost(); });
        document.addEventListener('keydown', (e) => { if (e.key==='Escape' && postModal && !postModal.hidden) hidePost(); });

        // Photos grid interactions: open modal, edit, delete
        if (photosGrid){
          photosGrid.addEventListener('click', (e) => {
            const imgLink = e.target.closest && e.target.closest('.photo-item a');
            if (!imgLink) return;
            e.preventDefault();
            const item = imgLink.closest('.photo-item');
            const id = item && item.getAttribute('data-id');
            const post = currentPosts.find(p => String(p.id) === String(id));
            if (post) showPhoto(post);
          });
        }

        // Modal action buttons reuse same logic
        photoEditBtn && photoEditBtn.addEventListener('click', async () => {
          if (!currentPhotoId) return;
          const user = await ensureSession(); if (!user) return;
          const post = currentPosts.find(p => String(p.id) === String(currentPhotoId)); if (!post) return;
          const next = window.prompt('Tāpiri/kua whakatika kupu / Add or edit caption:', post.content || '');
          if (next == null) return;
          try{
            const { error } = await sb.from('posts').update({ content: next }).eq('id', post.id).eq('user_id', user.id);
            if (error) throw error;
            await loadPosts(user);
            if (photoCaption) photoCaption.textContent = next;
          }catch(_){ alert('Kāore i taea te whakatika / Failed to edit.'); }
        });
        photoDeleteBtn && photoDeleteBtn.addEventListener('click', async () => {
          if (!currentPhotoId) return;
          const user = await ensureSession(); if (!user) return;
          const post = currentPosts.find(p => String(p.id) === String(currentPhotoId)); if (!post) return;
          if (!window.confirm('Muku tēnei whakaahua? / Delete this photo?')) return;
          try{
            if (post.media_url){
              const path = storagePathFromPublicUrl(post.media_url);
              if (path){ await sb.storage.from('media').remove([path]); }
            }
            const { error } = await sb.from('posts').delete().eq('id', post.id).eq('user_id', user.id);
            if (error) throw error;
            await loadPosts(user);
            hidePhoto();
          }catch(_){ alert('Kāore i taea te muku / Failed to delete.'); }
        });

        // Save profile changes
        if (editForm){
          editForm.addEventListener('submit', async (e) => {
            e.preventDefault(); profileMsg.textContent='';
            const { data } = await sb.auth.getSession();
            const user = data.session?.user; if (!user){ profileMsg.textContent='Takiuru tuatahitia / Please login.'; return; }
            const updates = {};
            const full = (editFullName && editFullName.value || '').trim(); if (full) updates.full_name = full;
            const pepehaUpdates = {};
            if (editMaunga && editMaunga.value.trim()) pepehaUpdates.maunga = editMaunga.value.trim();
            if (editAwa && editAwa.value.trim()) pepehaUpdates.awa = editAwa.value.trim();
            if (editIwi && editIwi.value.trim()) pepehaUpdates.iwi = editIwi.value.trim();
            if (editHapu && editHapu.value.trim()) pepehaUpdates.hapu = editHapu.value.trim();
            if (editWaka && editWaka.value.trim()) pepehaUpdates.waka = editWaka.value.trim();
            if (editMarae && editMarae.value.trim()) pepehaUpdates.marae = editMarae.value.trim();
            if (Object.keys(pepehaUpdates).length) updates.pepeha = pepehaUpdates;
            try{
              if (editAvatar && editAvatar.files && editAvatar.files[0]){
                try{
                  const url = await uploadProfileFile('avatar', editAvatar.files[0], user);
                  updates.avatar_url = url;
                }catch(err){
                  console.error('Avatar upload failed', err);
                  profileMsg.textContent = 'Kāore i taea te tuku whakaahua kōtaha / Avatar upload failed.';
                  return;
                }
              }
              if (editCover && editCover.files && editCover.files[0]){
                try{
                  const url = await uploadProfileFile('cover', editCover.files[0], user);
                  updates.cover_url = url;
                }catch(err){
                  console.error('Cover upload failed', err);
                  profileMsg.textContent = 'Kāore i taea te tuku whakaahua uhi / Cover upload failed.';
                  return;
                }
              }
              if (Object.keys(updates).length){
                const { data: upd, error } = await sb.auth.updateUser({ data: updates });
                if (error) throw error;
                // Update UI
                const newUser = upd.user || user;
                if (profileName) profileName.textContent = (updates.full_name || newUser.user_metadata?.full_name || '—');
                renderPepeha(newUser.user_metadata?.pepeha || updates.pepeha || null);
                if (avatarImg) { const url = updates.avatar_url || newUser.user_metadata?.avatar_url || placeholderAvatar(newUser); avatarImg.src = url; avatarImg.style.display='block'; }
                { const url = updates.cover_url || newUser.user_metadata?.cover_url || placeholderCover(newUser); applyCover(url); }
              }
              profileMsg.textContent = 'Kua tiakina / Saved';
              // reset file inputs
              if (editAvatar) editAvatar.value = '';
              if (editCover) editCover.value = '';
              hideEdit();
            }catch(err){ profileMsg.textContent = 'Hapa / Error saving profile.'; }
          });
        }

        // Bootstrap
        (async function init(){
          const user = await ensureSession();
          if (user) loadPosts(user);
        })();
      })();
    </script>
    <script src="assets/app.js"></script>
  </body>
</html>
