<!doctype html>
<html lang="mi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Whakapapa — Te Kōrero Whānau</title>
    <meta name="description" content="Whakapapa: Build our whānau tree and connections." />
    <link rel="stylesheet" href="assets/styles.css" />
    <link rel="stylesheet" href="https://unpkg.com/vis-network/styles/vis-network.css" />
  </head>
  <body>
    <header class="papa">
      <div class="logo">Te Kōrero Whānau</div>
      <nav>
        <button class="nav-toggle" aria-expanded="false" aria-controls="whanau-nav" title="Whakatuwhera tahua / Open menu">≡</button>
        <button id="theme-toggle" class="theme-toggle" aria-pressed="false" title="Kōwhiri āhua / Toggle theme">☀︎</button>
        <ul id="whanau-nav" class="nav-list">
          <li><a href="index.html">Kāinga</a></li>
          <li><a href="whakapapa.html">Whakapapa</a></li>
          <li><a href="korero.html">Kōrero</a></li>
          <li><a href="waiata.html">Waiata</a></li>
          <li><a href="karakia.html">Karakia</a></li>
          <li><a href="nga-toi.html">Ngā Toi</a></li>
          <li id="nav-admin-item" style="display:none"><a href="admin.html">Admin</a></li>
          <li id="nav-login-item"><a id="open-auth" href="#">Login</a></li>
          <li id="nav-profile-item" style="display:none"><a href="profile.html">Kōtaha / Profile</a></li>
          <li id="nav-signout-item" style="display:none"><button id="signout" class="btn-link">Takiputa / Sign out</button></li>
        </ul>
      </nav>
    </header>

    <main>
      <section id="whakapapa" class="panel">
        <h1>Whakapapa</h1>
        <figure class="hero-figure">
          <img loading="lazy" decoding="async" referrerpolicy="no-referrer" alt="Ngahere roots symbolising whakapapa connections" src="https://images.unsplash.com/photo-1523978591478-c753949ff840?auto=format&fit=crop&w=1200&h=420&q=80" onerror="this.onerror=null;this.src='https://images.unsplash.com/photo-1501785888041-af3ef285b470?auto=format&fit=crop&w=1200&h=420&q=80';" />
          <figcaption class="visually-hidden">Roots and forest</figcaption>
        </figure>
        <p>Build a family tree and pepeha. Connect iwi/hapū/waka affiliations. Learn and teach across generations.</p>
        <details class="fold">
          <summary>What info is helpful for whakapapa?</summary>
          <p>Full names, birth years, marae, iwi/hapū, and known relationships. Photos are a bonus.</p>
        </details>
      </section>

      <section class="panel">
        <h2>Te Rākau Whakapapa / Family tree</h2>
        <div class="tree-controls">
          <label>Root
            <select id="root-select"></select>
          </label>
          <label>
            <input id="only-connected" type="checkbox" checked /> Only connected to root
          </label>
          <label>
            Depth
            <input id="depth" type="range" min="1" max="6" value="3" />
            <span id="depth-val">3</span>
          </label>
          <button id="fit" class="btn outline" type="button">Whakarite / Fit</button>
        </div>
        <div id="whakapapa-tree" role="img" aria-label="Whānau relationship network"></div>
        <p id="whakapapa-msg" class="muted small"></p>
      </section>

      <section class="panel">
        <h2>Tāpiri Hononga / Add relation</h2>
        <form id="rel-form" class="form">
          <div style="display:flex;flex-wrap:wrap;gap:.5rem 1rem">
            <label style="flex:1;min-width:200px">Person A
              <select id="rel-a" required></select>
            </label>
            <label style="flex:0 0 160px">Type
              <select id="rel-type" required>
                <option value="parent">Parent of →</option>
                <option value="mother">Mother of →</option>
                <option value="father">Father of →</option>
                <option value="spouse">Spouse/Partner ↔</option>
                <option value="partner">Partner ↔</option>
              </select>
            </label>
            <label style="flex:1;min-width:200px">Person B
              <select id="rel-b" required></select>
            </label>
          </div>
          <p class="muted small">For parent types, we add A → B (parent to child). Spouse/partner is shown as a dashed line.</p>
          <div>
            <button class="btn" type="submit">Tāpiri / Add</button>
            <button class="btn outline" id="rel-fit" type="button">Whakarite / Fit</button>
          </div>
          <p id="rel-msg" class="muted small"></p>
        </form>
      </section>

      <section class="panel">
        <h2>Tāpiri Tāngata / Add person</h2>
        <form id="person-form" class="form" enctype="multipart/form-data">
          <label>Ingoa Katoa / Full name
            <input type="text" id="person-name" required />
          </label>
          <label>Īmēra / Email (optional)
            <input type="email" id="person-email" />
          </label>
          <label>Whakaahua / Avatar (optional)
            <input type="file" id="person-avatar" accept="image/*" />
          </label>
          <div>
            <button class="btn" type="submit">Waihanga / Create</button>
          </div>
          <p id="person-msg" class="muted small"></p>
        </form>
      </section>
    </main>

    <!-- Auth modal -->
    <div id="auth-modal" class="modal" hidden aria-hidden="true" role="dialog" aria-labelledby="auth-title">
      <div class="modal-content">
        <button class="modal-close" aria-label="Katia te matapihi / Close" id="auth-close">×</button>
        <h2 id="auth-title">Takiuru / Rēhita</h2>
        <div class="tabpanes">
          <form id="login-form" class="form" autocomplete="on">
            <label>Email
              <input type="email" name="email" required />
            </label>
            <label>Kupuhipa / Password
              <input type="password" name="password" required minlength="6" />
            </label>
            <button type="submit" class="btn">Takiuru</button>
            <p class="muted small" id="login-msg"></p>
          </form>
          <form id="register-form" class="form" autocomplete="on" hidden>
            <label>Ingoa / Full name (optional)
              <input type="text" name="full_name" />
            </label>
            <label>Email
              <input type="email" name="email" required />
            </label>
            <label>Kupuhipa / Password
              <input type="password" name="password" required minlength="6" />
            </label>
            <button type="submit" class="btn">Rēhita</button>
            <p class="muted small" id="register-msg"></p>
          </form>
        </div>
      </div>
    </div>

    <footer>
      <small>© <span id="year"></span> Te Kōrero Whānau — He taonga tuku iho.</small>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="assets/auth.js"></script>
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <script>
      (function(){
        const msg = document.getElementById('whakapapa-msg');
        const container = document.getElementById('whakapapa-tree');
        const sel = document.getElementById('root-select');
        const onlyConnected = document.getElementById('only-connected');
        const depthInput = document.getElementById('depth');
        const depthVal = document.getElementById('depth-val');
        const fitBtn = document.getElementById('fit');

        const hasVis = !!window.vis;
        if (!container || !hasVis){
          if (msg) msg.textContent = 'Network library failed to load.';
          return;
        }

        const sb = window.sb; // Supabase client from auth.js (if configured)

        function avatarOf(p){
          return p.avatar_url || p.photo_url || p.image_url || p.avatar || null;
        }
        function displayName(p){
          return p.full_name || p.name || p.email || '—';
        }
        function toNode(p){
          const img = avatarOf(p);
          if (img){
            return { id: p.id, label: displayName(p), shape: 'circularImage', image: img, borderWidth: 1 };
          }
          return { id: p.id, label: displayName(p), shape: 'box' };
        }
        function toEdge(r){
          if (r.type === 'parent' || r.type === 'mother' || r.type === 'father'){
            return { from: r.from_id, to: r.to_id, arrows: 'to', label: 'parent', color: { color: '#6ec5be' } };
          }
          if (r.type === 'spouse' || r.type === 'partner'){
            return { from: r.from_id, to: r.to_id, dashes: true, label: 'spouse', color: { color: '#c58f6e' } };
          }
          return { from: r.from_id, to: r.to_id, color: { color: '#9aa3a7' } };
        }

        const opts = {
          layout: { hierarchical: { enabled: true, direction: 'UD', sortMethod: 'directed', nodeSpacing: 150, levelSeparation: 120 } },
          physics: false,
          nodes: { color: { background: 'var(--panel)', border: 'var(--border)' }, font: { color: 'var(--fg)' }, borderWidth: 1 },
          edges: { smooth: { type: 'cubicBezier' }, font: { color: 'var(--muted)' } }
        };

        let profiles = [];
        let relations = [];
        let allNodes = new vis.DataSet([]);
        let allEdges = new vis.DataSet([]);
        let network = new vis.Network(container, { nodes: allNodes, edges: allEdges }, opts);

        function neighborsWithin(rootId, maxDepth){
          const adj = new Map();
          allEdges.forEach(e => {
            if (!adj.has(e.from)) adj.set(e.from, []);
            if (!adj.has(e.to)) adj.set(e.to, []);
            adj.get(e.from).push(e.to);
            adj.get(e.to).push(e.from);
          });
          const seen = new Set([rootId]);
          const q = [[rootId,0]];
          while (q.length){
            const [u,d] = q.shift();
            if (d >= maxDepth) continue;
            const ns = adj.get(u) || [];
            for (const v of ns){
              if (!seen.has(v)) { seen.add(v); q.push([v,d+1]); }
            }
          }
          return seen;
        }

        function applyFilter(){
          const rootId = sel.value || (allNodes.getIds()[0] || null);
          const d = parseInt(depthInput.value || '3', 10);
          depthVal.textContent = String(d);
          if (!onlyConnected.checked || !rootId){
            network.setData({ nodes: allNodes, edges: allEdges });
            if (rootId) network.focus(rootId, { animation: true, scale: 1 });
            return;
          }
          const keep = neighborsWithin(rootId, d);
          const nodes = new vis.DataSet(allNodes.get({ filter: n => keep.has(n.id) }));
          const edges = new vis.DataSet(allEdges.get({ filter: e => keep.has(e.from) && keep.has(e.to) }));
          network.setData({ nodes, edges });
          network.focus(rootId, { animation: true, scale: 1 });
        }

        function populateRootSelect(list){
          sel.innerHTML = '';
          list.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.id; opt.textContent = displayName(p);
            sel.appendChild(opt);
          });
        }
        function populateRelSelects(list){
          const a = document.getElementById('rel-a');
          const b = document.getElementById('rel-b');
          if (!a || !b) return;
          const add = (el) => {
            el.innerHTML = '';
            list.forEach(p => {
              const opt = document.createElement('option');
              opt.value = p.id; opt.textContent = displayName(p);
              el.appendChild(opt);
            });
          };
          add(a); add(b);
        }

        async function bootstrap(){
          try{
            profiles = [];
            relations = [];
            if (sb){
              // Try load from Supabase tables if they exist (select * to tolerate optional avatar fields)
              const p = await sb.from('profiles').select('*');
              const r = await sb.from('relationships').select('from_id, to_id, type');
              if (!p.error && Array.isArray(p.data)) profiles = p.data;
              if (!r.error && Array.isArray(r.data)) relations = r.data;
            }
            if (!profiles.length){
              // Fallback sample data (with placeholder avatars)
              const ph = (name) => `https://api.dicebear.com/7.x/initials/svg?seed=${encodeURIComponent(name)}`;
              profiles = [
                { id: 'A', full_name: 'Koro A', avatar_url: ph('Koro A') },
                { id: 'B', full_name: 'Kuia B', avatar_url: ph('Kuia B') },
                { id: 'C', full_name: 'Matua C', avatar_url: ph('Matua C') },
                { id: 'D', full_name: 'Whaea D', avatar_url: ph('Whaea D') },
                { id: 'E', full_name: 'Tamariki E', avatar_url: ph('Tamariki E') },
                { id: 'F', full_name: 'Tamariki F', avatar_url: ph('Tamariki F') }
              ];
              relations = [
                { from_id: 'A', to_id: 'C', type: 'parent' },
                { from_id: 'B', to_id: 'C', type: 'parent' },
                { from_id: 'C', to_id: 'E', type: 'parent' },
                { from_id: 'D', to_id: 'E', type: 'parent' },
                { from_id: 'C', to_id: 'D', type: 'spouse' },
                { from_id: 'C', to_id: 'F', type: 'parent' },
                { from_id: 'D', to_id: 'F', type: 'parent' }
              ];
              if (msg) msg.textContent = 'Using sample data. Create Supabase tables "profiles" (add avatar_url) and "relationships" to load real whānau.';
            } else {
              if (msg) msg.textContent = '';
            }

            allNodes = new vis.DataSet(profiles.map(toNode));
            allEdges = new vis.DataSet(relations.map(toEdge));
            network.setData({ nodes: allNodes, edges: allEdges });

            populateRootSelect(profiles);
            populateRelSelects(profiles);

            // Default root: current user if available
            if (sb){
              const { data } = await sb.auth.getSession();
              const uid = data.session?.user?.id;
              if (uid && profiles.some(p => p.id === uid)) sel.value = uid;
            }

            applyFilter();
          }catch(err){
            if (msg) msg.textContent = 'Kāore i taea te uta te rākau whakapapa / Unable to load family tree.';
          }
        }

        sel.addEventListener('change', applyFilter);
        onlyConnected.addEventListener('change', applyFilter);
        depthInput.addEventListener('input', applyFilter);
        fitBtn.addEventListener('click', () => network.fit({ animation: true }));

        // Add relation form
        const relForm = document.getElementById('rel-form');
        const relFit = document.getElementById('rel-fit');
        const relMsg = document.getElementById('rel-msg');
        if (relFit) relFit.addEventListener('click', () => network.fit({ animation: true }));
        if (relForm){
          relForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            relMsg.textContent = '';
            const from_id = document.getElementById('rel-a').value;
            const to_id = document.getElementById('rel-b').value;
            const type = document.getElementById('rel-type').value;
            if (!from_id || !to_id || !type){ relMsg.textContent = 'Kōwhiria te tāngata me te momo hononga / Select people and relation type.'; return; }
            if (from_id === to_id){ relMsg.textContent = 'Kāore e tika te hono ki a ia anō / Cannot relate a person to themselves.'; return; }
            try{
              if (sb){
                const { error } = await sb.from('relationships').insert({ from_id, to_id, type });
                if (error) throw error;
                relMsg.textContent = 'Kua tāpirihia / Added.';
              } else {
                relMsg.textContent = 'Added locally (not saved). Configure Supabase to persist.';
              }
              // Update local graph
              relations.push({ from_id, to_id, type });
              allEdges.add(toEdge({ from_id, to_id, type }));
              applyFilter();
            }catch(err){
              relMsg.textContent = 'Hapa tāpiri / Failed to add relation.';
            }
          });
        }

        // Add person form
        const personForm = document.getElementById('person-form');
        const personMsg = document.getElementById('person-msg');
        if (personForm){
          personForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            personMsg.textContent = '';
            const full_name = String(document.getElementById('person-name').value || '').trim();
            const email = String(document.getElementById('person-email').value || '').trim() || null;
            const fileInput = document.getElementById('person-avatar');
            const file = fileInput && fileInput.files && fileInput.files[0] ? fileInput.files[0] : null;
            if (!full_name){ personMsg.textContent = 'Tāuruhia te ingoa / Enter a name.'; return; }
            try{
              let newProfile = null;
              if (sb){
                // Insert profile row
                const ins = await sb.from('profiles').insert({ full_name, email }).select('id, full_name, email').single();
                if (ins.error) throw ins.error;
                newProfile = ins.data;
                // Upload avatar if present
                if (file){
                  const ext = (file.name.split('.').pop() || 'jpg').toLowerCase();
                  const path = `avatars/${newProfile.id}-${Date.now()}.${ext}`;
                  const up = await sb.storage.from('media').upload(path, file, { upsert: false, cacheControl: '3600' });
                  if (up.error) throw up.error;
                  const pub = sb.storage.from('media').getPublicUrl(path);
                  const upd = await sb.from('profiles').update({ avatar_url: pub.data.publicUrl }).eq('id', newProfile.id);
                  if (upd.error) throw upd.error;
                  newProfile.avatar_url = pub.data.publicUrl;
                }
              } else {
                // Local-only fallback
                const id = 'P' + Date.now();
                let avatar_url = null;
                if (file){ avatar_url = URL.createObjectURL(file); }
                newProfile = { id, full_name, email, avatar_url };
              }

              // Update UI datasets
              profiles.push(newProfile);
              allNodes.add(toNode(newProfile));
              populateRootSelect(profiles);
              populateRelSelects(profiles);
              applyFilter();
              personForm.reset();
              personMsg.textContent = sb ? 'Kua waihangatia / Created.' : 'Created locally (not saved). Configure Supabase to persist.';
            } catch(err){
              personMsg.textContent = 'Hapa waihanga / Failed to create person. Ensure profiles table exists and storage bucket "media" allows uploads.';
            }
          });
        }

        bootstrap();
      })();
    </script>
    <script src="assets/app.js"></script>
  </body>
</html>
